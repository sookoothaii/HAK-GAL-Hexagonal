{
    admin off
}

:8088 {
    log {
        output stdout
        level INFO
    }

    handle /@vite/client {
        reverse_proxy 127.0.0.1:5173
        header Content-Type "application/javascript"
    }

    handle /@vite/* {
        reverse_proxy 127.0.0.1:5173
        header Content-Type "application/javascript"
    }

    handle /src/* {
        reverse_proxy 127.0.0.1:5173
        header Content-Type "application/javascript"
    }

    handle /node_modules/* {
        reverse_proxy 127.0.0.1:5173
    }

    handle_path /*.css {
        reverse_proxy 127.0.0.1:5173
        header Content-Type "text/css"
    }

    handle /assets/* {
        reverse_proxy 127.0.0.1:5173
    }

    @kb_page {
        path /api/knowledge-base/page*
    }
    handle @kb_page {
        rewrite * /api/facts{query}
        reverse_proxy 127.0.0.1:5002
    }

    @kb_raw {
        path /api/knowledge-base/raw
    }
    rewrite @kb_raw /api/facts?limit=1000

    @kb_status {
        path /api/knowledge-base/status
    }
    rewrite @kb_status /api/facts/count

    handle /api/* {
        reverse_proxy 127.0.0.1:5002 {
            header_up X-API-Key {header.X-API-Key}
            transport http {
                dial_timeout 3s
                response_header_timeout 5m
                read_timeout 15m
                write_timeout 15m
            }
        }
    }

    handle /health {
        reverse_proxy 127.0.0.1:5002
    }

    handle /socket.io/* {
        reverse_proxy 127.0.0.1:5002 {
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}
            header_up Host {http.request.host}
            transport http {
                dial_timeout 3s
                response_header_timeout 60s
                read_timeout 60m
                write_timeout 60m
            }
        }
    }

    handle {
        reverse_proxy 127.0.0.1:5173
    }
}