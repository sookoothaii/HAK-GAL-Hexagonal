{
  "id": "auto-backup-recovery",
  "name": "Automatisches Backup & Recovery",
  "description": "Tägliche Backups mit Integritätsprüfung und Rotation",
  "nodes": [
    {
      "id": "cron_validate_1",
      "type": "cron_validator",
      "position": { "x": 100, "y": 100 },
      "data": {
        "expression": "0 3 * * *",
        "description": "Validiere Cron-Ausdruck"
      }
    },
    {
      "id": "schedule_2",
      "type": "schedule_trigger",
      "position": { "x": 100, "y": 200 },
      "data": {
        "schedule": "0 3 * * *",
        "description": "Täglich um 3:00 Uhr"
      }
    },
    {
      "id": "db_pragma_1",
      "type": "db_get_pragma",
      "position": { "x": 100, "y": 300 },
      "data": {}
    },
    {
      "id": "branch_wal",
      "type": "branch",
      "position": { "x": 100, "y": 400 },
      "data": {
        "condition": "{{db_pragma_1.journal_mode}} != 'wal'"
      }
    },
    {
      "id": "db_enable_wal_1",
      "type": "db_enable_wal",
      "position": { "x": 250, "y": 500 },
      "data": {
        "synchronous": "NORMAL"
      }
    },
    {
      "id": "no_op_1",
      "type": "no_op",
      "position": { "x": 50, "y": 500 },
      "data": {
        "description": "WAL bereits aktiv"
      }
    },
    {
      "id": "kb_stats_2",
      "type": "kb_stats",
      "position": { "x": 100, "y": 600 },
      "data": {}
    },
    {
      "id": "set_var_2",
      "type": "set_variable",
      "position": { "x": 100, "y": 700 },
      "data": {
        "name": "kb_size",
        "value": "{{kb_stats_2.size_bytes}}"
      }
    },
    {
      "id": "db_backup_1",
      "type": "db_backup_now",
      "position": { "x": 100, "y": 800 },
      "data": {}
    },
    {
      "id": "get_file_info_1",
      "type": "get_file_info",
      "position": { "x": 100, "y": 900 },
      "data": {
        "path": "{{db_backup_1.backup_path}}"
      }
    },
    {
      "id": "eval_2",
      "type": "evaluate_expression",
      "position": { "x": 100, "y": 1000 },
      "data": {
        "expression": "{{get_file_info_1.size}} >= {{kb_size}} * 0.9"
      }
    },
    {
      "id": "if_valid",
      "type": "if_condition",
      "position": { "x": 100, "y": 1100 },
      "data": {
        "condition": "{{eval_2.result}} == true"
      }
    },
    {
      "id": "db_rotate_1",
      "type": "db_backup_rotate",
      "position": { "x": 250, "y": 1200 },
      "data": {
        "keep_last": 7
      }
    },
    {
      "id": "project_snapshot_2",
      "type": "project_snapshot",
      "position": { "x": 250, "y": 1300 },
      "data": {
        "title": "Daily_Backup_{{workflow.date}}",
        "description": "Automatisches Backup, KB: {{kb_stats_2.fact_count}} Fakten, Größe: {{kb_stats_2.size_mb}}MB",
        "auth_token": "{{env.WRITE_TOKEN}}"
      }
    },
    {
      "id": "comment_2",
      "type": "comment",
      "position": { "x": 250, "y": 1400 },
      "data": {
        "text": "Backup erfolgreich erstellt und verifiziert"
      }
    },
    {
      "id": "error_transform_1",
      "type": "error_transform",
      "position": { "x": 50, "y": 1200 },
      "data": {
        "error_message": "Backup-Validierung fehlgeschlagen: Backup-Größe {{get_file_info_1.size}} < erwartete Größe {{kb_size}} * 0.9"
      }
    },
    {
      "id": "circuit_breaker_2",
      "type": "circuit_breaker",
      "position": { "x": 50, "y": 1300 },
      "data": {
        "threshold": 1,
        "reset_timeout": 86400000,
        "description": "Verhindere weitere Backup-Versuche für 24h"
      }
    },
    {
      "id": "fallback_1",
      "type": "fallback_chain",
      "position": { "x": 50, "y": 1400 },
      "data": {
        "primary_action": "db_backup_now",
        "fallback_actions": [
          {
            "type": "execute_code",
            "config": {
              "language": "bash",
              "code": "cp hexagonal_kb.db backups/emergency_backup_$(date +%Y%m%d_%H%M%S).db"
            }
          },
          {
            "type": "delegate_task",
            "config": {
              "target_agent": "gemini",
              "task_description": "URGENT: Database backup failed. Manual intervention required."
            }
          }
        ]
      }
    },
    {
      "id": "add_fact_5",
      "type": "add_fact",
      "position": { "x": 100, "y": 1500 },
      "data": {
        "statement": "BackupCompleted({{workflow.timestamp}}, {{if_valid.result}}, size_{{get_file_info_1.size}}).",
        "auth_token": "{{env.WRITE_TOKEN}}"
      }
    }
  ],
  "edges": [
    { "id": "e1", "source": "cron_validate_1", "target": "schedule_2" },
    { "id": "e2", "source": "schedule_2", "target": "db_pragma_1" },
    { "id": "e3", "source": "db_pragma_1", "target": "branch_wal" },
    { "id": "e4", "source": "branch_wal", "sourceHandle": "true", "target": "db_enable_wal_1" },
    { "id": "e5", "source": "branch_wal", "sourceHandle": "false", "target": "no_op_1" },
    { "id": "e6", "source": "db_enable_wal_1", "target": "kb_stats_2" },
    { "id": "e7", "source": "no_op_1", "target": "kb_stats_2" },
    { "id": "e8", "source": "kb_stats_2", "target": "set_var_2" },
    { "id": "e9", "source": "set_var_2", "target": "db_backup_1" },
    { "id": "e10", "source": "db_backup_1", "target": "get_file_info_1" },
    { "id": "e11", "source": "get_file_info_1", "target": "eval_2" },
    { "id": "e12", "source": "eval_2", "target": "if_valid" },
    { "id": "e13", "source": "if_valid", "sourceHandle": "true", "target": "db_rotate_1" },
    { "id": "e14", "source": "db_rotate_1", "target": "project_snapshot_2" },
    { "id": "e15", "source": "project_snapshot_2", "target": "comment_2" },
    { "id": "e16", "source": "if_valid", "sourceHandle": "false", "target": "error_transform_1" },
    { "id": "e17", "source": "error_transform_1", "target": "circuit_breaker_2" },
    { "id": "e18", "source": "circuit_breaker_2", "target": "fallback_1" },
    { "id": "e19", "source": "comment_2", "target": "add_fact_5" },
    { "id": "e20", "source": "fallback_1", "target": "add_fact_5" }
  ],
  "version": "1.0"
}